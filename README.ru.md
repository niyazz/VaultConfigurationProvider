# VaultConfigurationProvider
Библиотека с поставщиком конфигурации из HashiCorp Vault.

### Описание решаемой проблемы
В условиях коллективной разработки проекта может возникнуть необходимость в хранении ключей API, токенов авторизации,
строк подключения к различной инфраструктуре и т.д. Данная информация является конфидициальной и по правилам безопасной разработки не мжет быть размещена
в стандартном ```appsettings.json```.

В свою очередь, при хранении секретов локально на машине разработчика (```appsettings.Development.json```,
блокноте, Word и т.д) появляется проблема содержания значений этих секретов в согласованном между всеми разработчиками, актуальном состоянии.
В добавок ко всему, перед командой встает вопрос поиска канала коммуникации, обеспечивающего безопасную передачу значений этих секретов.
Как правило, месседжеры, электронная почта, почтовые голуби и прочие средства для общения,
не обеспечивают должной защиты и будут доставлять дискомофрт в команде более чем из двух человек.

### Предлагаемое решение
Хранить секреты в отведенных для этого местах.

Например, ```HashiCorp Vault``` - поддерживает разные виды аутентицикации и позволяет хранить секреты безопасно.
Данный поставщик конфигурации использует аутентификацию по протоколу ```LDAP``` с помощью логина и пароля.

```Note:```
Рекомендуется использовать только для локальной разработки, когда секреты не хранятся в стандартном ```appsettings.json```.

---
## Создание файла секретов пользователя через терминал

Логин и пароль предлагается хранить в секретах пользователя (Microsoft User Secret Manager Tool) ввиду того, что этот файл хранится только на устройстве пользователя и может быть изменен с помощью ```dotnet tools````.

**По умолчанию папка имеет значение localdevvault**, однако это название может определять для себя каждый сам.

1. Инициализация директории секретов (не создается пока не добавлен секрет). Необходимо запускать в директории проекта!
 ```csharp
    // Смысл в том, чтобы у каждого разработчика была такая директория.
    dotnet user-secrets init --id localdev
```
2. Установка секрета логина и пароля. Создает директорию по пути ```C:\Users\{user}\AppData\Roaming\Microsoft\UserSecrets\{YOUR_FOLDER_NAME}``` (Linux: ```~/.microsoft/usersecrets/{YOUR_FOLDER_NAME}```) с файлом ```secret.json```.
   При смене логина и пароля эти строки стоит выполнить повторно.
 ```csharp
    dotnet user-secrets set VaultProvider:Username "{YOUR_LOGIN}" --id localdevvault
    dotnet user-secrets set VaultProvider:Password "{YOUR_PASSWORD}" --id localdevvault
```
3. Проверка, что секреты установлены.
 ```csharp
    dotnet user-secrets list --id localdevvault
```

---
## Установка библиотеки
1. Создаем файл секретов через терминал (выше есть инструкция) или используя IDE.
2. Устанавливаем ```VaultConfigurationProvider```.
3. В классе ```Program.cs```регистрируем новый провайдер конфигурации из Vault`а.

   Для локальной разработки вполне хватает следующей настройки.
```csharp
 builder.Configuration
        .AddJsonFile("appsettings.json")
        ...
        .AddLocalDevelopmentVault(options => {
             options.SecretsSubPaths = new[] {"somepath/service_name1"};
        }, optional: false);
```
---
## Настройки поставщика
1. ```BaseUrl``` - адрес  инстанса Vault, по умолчанию.
2. ```MountPoint``` - тип привязки к секретам, по умолчанию ```secret```.
3. ```SecretsBasePath``` - базовый путь до контура Vault.
4. ```SecretsCommonPath``` - базовый путь до общих секретов.
5. ```UseSecretsCommonPath``` - использовать SecretsCommonPath, по умолчанию ```true```
6. ```SecretsSubPaths``` - путь до секретов сервиса (может быть несколько). Пример: ```sector/service_name```.
7. ```DefaultExceptKeys``` - набор ключей по умолчанию, которые не переопределяются в конфигурации даже если их завели в Vault.
8. ```UseDefaultExceptKeys``` - нужно ли пропускать ключи из списка ```DefaultExceptKeys```, по умолчанию ```true```.
9. ```ExceptKeys``` - ключи, которые не нужно переопределять. Можно задать секцию целиком. Пример: ```["App", "Db:ConnectionString"]``` .
10. ```RequiredKeys``` - ключи, которые нужно переопределить даже если они попадают под правила ```ExceptKeys```. Только полная иерархия ключа, секция не допускается.
11. ```EnvironmentVariablePrefix``` - префикс используемый для фильтрации переменных окружения среды. По умолчанию ```ENV_```.
12. ```SourceSeparator``` - разделитель для иерархического ключа в хранилище, по умолчанию ```__```.
13. ```DestinationSeparator``` - разделитель для иерархического ключа в конфигурации приложения, по умолчанию ```:```.

Расширенная настройка:
```csharp
        builder.AddLocalDevelopmentVault(options => {
             options.SecretsBasePath = "somepath/anothepath";
             options.SecretsCommonPath = "_shared/new_common"
             options.SecretsSubPaths = new[] {"sector/service_name1"};
             options.ExceptKeys = new[] {"App:DbConnectionString", "SomeSection"};
             options.RequiredKeys = "SomeSection:Settings:BaseUrl";
        }, optional: false);
```
